x-server-environment: &server-environment
    ALCOVES_TASK_DB_PORT: 6379
    ALCOVES_TASK_DB_HOST: dragonfly
    ALCOVES_DB_CONNECTION_STRING: postgres://postgres:postgres@postgres:5432/alcoves

services:
    server:
        container_name: server
        build:
            context: .
            dockerfile: Dockerfile.dev
        command: bun run dev:server
        environment:
            <<: *server-environment
        volumes:
            - ./:/app
            - /app/node_modules
        depends_on:
            - minio
            - minio-mb
            - postgres
            - dragonfly
        ports:
            - 3000:3000
    worker:
        container_name: worker
        build:
            context: .
            dockerfile: Dockerfile.dev
        command: bun run dev:worker
        environment:
            <<: *server-environment
        volumes:
            - ./:/app
            - /app/node_modules
        depends_on:
            - server
            - minio
            - minio-mb
            - postgres
            - dragonfly
    dragonfly:
        container_name: dragonfly
        image: docker.dragonflydb.io/dragonflydb/dragonfly
        restart: always
        ulimits:
            memlock: -1
        ports:
            - 6100:6379
        volumes:
            - dragonfly:/data
    postgres:
        container_name: postgres
        image: postgres:16
        restart: always
        ports:
            - 6200:5432
        volumes:
            - postgres:/var/lib/postgresql/data/
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready', '-U', 'postgres', '-d', 'alcoves']
            retries: 30
            timeout: 5s
            interval: 1s
        user: postgres
        environment:
            POSTGRES_DB: alcoves
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
    minio:
        image: minio/minio
        volumes:
            - minio:/data
        environment:
            MINIO_ROOT_USER: minioadmin
            MINIO_ROOT_PASSWORD: minioadmin
        ports:
            - '9000:9000'
            - '9001:9001'
        command: server /data --console-address ":9001"

    minio-mb:
        image: minio/mc
        depends_on:
            - minio
        entrypoint: sh -c "mc config host add minio http://minio:9000 minioadmin minioadmin && mc mb minio/alcoves"
volumes:
    minio:
    postgres:
    dragonfly:
networks:
    default:
        name: alcoves
